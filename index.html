<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="icon" href="">
    <style type="text/css">
      code, pre {
        background-color: #6666;
        padding: 2px;
        display: inline-block;
      }
      pre code {
        background-color: #0000;
        padding: 0px;
      }
    </style>
    <style type="text/css" media="(prefers-color-scheme: light)">
    </style>
    <style type="text/css" media="(prefers-color-scheme: dark)">
      body {background-color: black; color: white;}
      a {filter: invert(1) brightness(0.5) invert(1);}
      select, button, input {filter: invert(1);}
    </style>
    <style type="text/css" media="(prefers-color-scheme: never)">
      body {background-color: red;}
    </style>
    <script src="https://cdn.rawgit.com/showdownjs/showdown/1.9.1/dist/showdown.min.js"></script>
    <script>
var getParams = {};
getPairs = location.search.substr(1).split('&');
for (i in getPairs) {
  getParams[getPairs[i].split('=')[0]] = getPairs[i].split('=')[1];
}

fileToRender = 'README.md';
if ('fileToRender' in getParams){
  fileToRender = getParams['fileToRender'];
}
converter = new showdown.Converter();
html = converter.makeHtml('loading ``' + fileToRender + '`` ...');

function makeFaviconText(textIn) {
  var svg = 'data:image/svg+xml,' +
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">' +
    '<text paint-order="stroke" stroke="white" stroke-width="16" ' +
    'fill="black" font-stretch="ultra-condensed" font-family="mono" ' +
    'y=".9em" font-size="90">' + textIn + '</text></svg>';
  document.querySelector('link[rel~="icon"]').href=svg;
}
makeFaviconText('⏳');

function reqListener () {
  var renderedMarkdown = document.getElementById('renderedMarkdown');
  renderedMarkdown.innerHTML = converter.makeHtml(this.responseText);
  document.title = renderedMarkdown.children[0].innerText;
  makeFaviconText(document.title);
  if ((this.status < 200 || this.status > 300) && this.status != 304) {
    renderedMarkdown.innerHTML = converter.makeHtml('Status ' + this.status);
    document.title = this.status;
    makeFaviconText('❌');
    console.log(this);
  }
  if (location.href.split('#').length > 1) {location.href = location.href;}
}

cssAlwaysMedia = document.styleSheets[0].media.mediaText;
cssLightMedia  = document.styleSheets[1].media.mediaText;
cssDarkMedia   = document.styleSheets[2].media.mediaText;
cssNeverMedia  = document.styleSheets[3].media.mediaText;
cssLight = document.styleSheets[1];
cssDark  = document.styleSheets[2];

menuOptions = {'theme': {
  'auto': true,
  'dark': false,
  'light': false,
}, 'text-width': {
  'full-width': true,
  'readable': false,
}, 'font-family': {
  'serif': false,
  'sans-serif': true,
  'monospace': false,
}};
var selectedOptions = {};
// Defaults...
for (i in menuOptions) {
  for (j in menuOptions[i]) {
    if (menuOptions[i][j]) {
      selectedOptions[i] = j;
    }
  }
}
// ...first overriden by localStorage...
for (i in menuOptions) {
  if (localStorage.getItem(i) in menuOptions[i]) {
    selectedOptions[i] = localStorage.getItem(i);
  }
}
// ...then overriden by GET parameters
for (i in menuOptions) {
  if (getParams[i] in menuOptions[i]) {
    selectedOptions[i] = getParams[i];
  }
}

function toggleMenu () {
  miniMenu = '<button style="float:right;" onclick="toggleMenu()">☰</button>';
  var mDiv = document.getElementById('indexmdmenu');
  if (mDiv.innerHTML == miniMenu) {
    bigMenu = miniMenu;
    for (i in menuOptions){
      bigMenu += '<select id="' + i + '"' +
        (i == Object.keys(menuOptions)[0] ? '' : ' style="width:100%;"') + '>';
      for (j in menuOptions[i]) {
        bigMenu += '<option value="' + j + '"' +
          (selectedOptions[i] == [j] ? ' selected' : '') +
          '>' + j + '</option>';
      }
      bigMenu += '</select><br />';
    }
    bigMenu += '<input type="text" size=8 id="fileToRender" ' +
      'style="box-sizing:border-box; width:100%;" value="' +
      fileToRender + '"><br />';
    mDiv.innerHTML = bigMenu;
  }else{
    mDiv.innerHTML = miniMenu;
  }
}

function menuEffect() {
  for(i in menuOptions){
    var selectElement = document.getElementById(i);
    selectedOptions[i] = selectElement.selectedOptions[0].innerText;
    if (menuOptions[i][selectedOptions[i]]) { // Unset if default
      localStorage.removeItem(i);
    }else{ // Set if not default
      localStorage.setItem(i, selectedOptions[i]);
    }
  }
  settingsApply();
}

function settingsApply() {
  switch (selectedOptions['theme']) {
    case 'dark':
      cssDark.media.mediaText  = cssAlwaysMedia;
      cssLight.media.mediaText = cssNeverMedia;
      break;
    case 'light':
      cssDark.media.mediaText  = cssNeverMedia;
      cssLight.media.mediaText = cssAlwaysMedia;
      break;
    default:
      cssDark.media.mediaText  = cssDarkMedia;
      cssLight.media.mediaText = cssLightMedia;
  }
  switch (selectedOptions['text-width']) {
    case 'readable':
      document.body.style.maxWidth='70ch';
      break;
    default:
      document.body.style.maxWidth='';
  }
  document.body.style.fontFamily=selectedOptions['font-family'];
  newTarget = document.getElementById('fileToRender');
  if (newTarget && newTarget.value != fileToRender){
    fileToRender = newTarget.value;
    oReq.open('GET', fileToRender);
    oReq.send();
  }
}

function main() {
  toggleMenu();
  settingsApply();
  oReq = new XMLHttpRequest();
  oReq.addEventListener('load', reqListener);
  oReq.open('GET', fileToRender);
  oReq.send();
}
    </script>
	</head>
  <body onload="main()">
    <div id="indexmdmenu" style="float:right; max-width:30vw; border:dotted" onchange="menuEffect()"></div>
    <div id="renderedMarkdown"></div>
	</body>
</html>

